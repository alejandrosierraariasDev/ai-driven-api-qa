"""
‚úÖ Pipeline .gitlab-ci.yml del Repo 1 ‚Üí api_spec
Valide la OpenAPI

Bloquee si est√° mal

Y solo si est√° bien, dispare el pipeline del repo 2 (IA_Code).

Ejecuta cuando se modifique el archivo OpenAPI (openapi.yaml) y haya un merge en dev, y lanza el pipeline en repo 2.

Tools enforcement policy:
- API validation: Spectral 
- Backend development: Python
- Tests: Python + PyTest

"""


stages:
  - validate
  - trigger

variables:
  SPEC_FILE: "spec/openapi.yaml"
  SPECTRAL_FILE: ".spectral.yaml"

validate_openapi:
  stage: validate
  image: node:18
  rules:
    - changes:
        - spec/openapi.yaml
      if: '$CI_COMMIT_BRANCH == "dev"'
  script:
    - npm install -g @stoplight/spectral-cli swagger-cli

    # 1) validar sintaxis
    - echo "üìå Validando sintaxis OpenAPI..."
    - swagger-cli validate $SPEC_FILE

    # 2) Crear Spectral config si NO existe
    - |
      if [ ! -f "$SPECTRAL_FILE" ]; then
        echo "‚ö†Ô∏è No existe .spectral.yaml ‚Äî Creando archivo por defecto..."
        cat << 'EOF' > $SPECTRAL_FILE
extends: "spectral:oas"

rules:
  operation-description:
    description: "Endpoints must include a description."
    severity: error
    given: "$.paths[*][*]"
    then:
      field: description
      function: truthy

  schema-must-have-type:
    description: "Every property must define a 'type'."
    severity: error
    given: "$.components.schemas.*.properties.*"
    then:
      field: type
      function: truthy

  required-fields:
    description: "Schemas with properties should define 'required'."
    severity: warn
    given: "$.components.schemas.*"
    then:
      field: required
      function: truthy

  example-required:
    description: "Properties should include example values."
    severity: warn
    given: "$.components.schemas.*.properties.*"
    then:
      field: example
      function: truthy
EOF
      fi

    # 3) Validaci√≥n de calidad con Spectral
    - echo "üîç Validando calidad OpenAPI con Spectral..."
    - spectral lint $SPEC_FILE --ruleset $SPECTRAL_FILE --fail-severity "warn"

  allow_failure: false


trigger_ai_pipeline:
  stage: trigger
  needs: [validate_openapi]
  rules:
    - changes:
        - spec/openapi.yaml
      if: '$CI_COMMIT_BRANCH == "dev"'
  trigger:
    project: "sngular-solutions/qe/IA_Code"
    branch: "master"
    strategy: depend
