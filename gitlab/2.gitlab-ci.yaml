"""
Pipeline 2: Repo 2 ‚Üí Repo 3

Trigger: pipeline desde Repo 1 (manual o trigger).

Steps:

Descargar Repo 3.

Copiar output de IA en el lugar adecuado.

Crear nueva rama siguiendo nomenclatura espec√≠fica.

Commit y push.

Crear Merge Request con patr√≥n espec√≠fico.

Aqu√≠ run_ai.py es el script que mencionaste antes y se ejecuta de manera aut√≥noma.
El MR se crea usando la API de GitLab (puedes usar python-gitlab tambi√©n para m√°s robustez).


"""
# .gitlab-ci.yml de Repo 2

stages:
  - generate
  - push_output

variables:
  GIT_STRATEGY: clone
  OUTPUT_FILE: "output/chat_output.py"

generate_ai_output:
  stage: generate
  script:
    - pip install -r requirements.txt
    - python3 main.py
  artifacts:
    paths:
      - output/

push_to_target_repo:
  stage: push_output
  needs: ["generate_ai_output"]
  script:
    - git config --global user.email "automation@system.ai"
    - git config --global user.name "AI Automation Bot"

    - git clone https://oauth2:$GITLAB_TOKEN@gitlab.preving.com/sngular-solutions/qe/QADev_code.git target_repo
    - cd target_repo

    # Crear rama feature basada en timestamp
    - BRANCH_NAME="feature-ai-update-$(date +%Y%m%d%H%M)"
    - git checkout -b $BRANCH_NAME

    # Copiar output
    - cp ../output/chat_output.py .

    # Commit + Push
    - git add .
    - git commit -m "ü§ñ AI Generated Update from API Spec"
    - git push origin $BRANCH_NAME

    # Crear MR via API
    - curl --request POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
      "https://gitlab.preving.com/api/v4/projects/$(curl -s --header \"PRIVATE-TOKEN: $GITLAB_TOKEN\" https://gitlab.preving.com/api/v4/projects | jq '.[] | select(.name==\"QADev_code\") | .id')/merge_requests?source_branch=$BRANCH_NAME&target_branch=dev&title=AI%20Update%20from%20API%20Spec"
